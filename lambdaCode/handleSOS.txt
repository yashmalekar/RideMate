import {
  DynamoDBClient
} from "@aws-sdk/client-dynamodb";
import {
  DynamoDBDocumentClient,
  PutCommand,
  GetCommand,
  ScanCommand,
  DeleteCommand
} from "@aws-sdk/lib-dynamodb";

const client = new DynamoDBClient({ region: "ap-south-1" });
const docClient = DynamoDBDocumentClient.from(client);

export const handler = async (event) => {
  console.log("Event:", event);

  const tableName = "SOS"; // DynamoDB table name

  try {
    const method = event.httpMethod || event.requestContext?.http?.method;

    // ---------- CREATE / UPDATE ----------
    if (method === "POST") {
      const body = JSON.parse(event.body);

      if (!body.id || !body.name || !body.phone) {
        return sendResponse(400, {
          message: "Missing required fields: id, name, or phone",
        });
      }

      const contact = {
        id: body.id,
        name: body.name,
        phone: body.phone,
      };

      await docClient.send(
        new PutCommand({
          TableName: tableName,
          Item: contact,
        })
      );

      return sendResponse(200, {
        message: "SOS contact saved successfully",
        contact,
      });
    }

    // ---------- READ (GET by id or all) ----------
    if (method === "GET") {
      const id = event.queryStringParameters?.id;

      if (id) {
        const data = await docClient.send(
          new GetCommand({
            TableName: tableName,
            Key: { id },
          })
        );

        if (!data.Item)
          return sendResponse(404, { message: "SOS contact not found" });

        return sendResponse(200, data.Item);
      } else {
        const data = await docClient.send(new ScanCommand({ TableName: tableName }));
        return sendResponse(200, data.Items || []);
      }
    }

    // ---------- DELETE (by id) ----------
    if (method === "DELETE") {
      const id = event.queryStringParameters?.id;

      if (!id) {
        return sendResponse(400, { message: "Missing id parameter" });
      }

      await docClient.send(
        new DeleteCommand({
          TableName: tableName,
          Key: { id },
        })
      );

      return sendResponse(200, {
        message: `SOS contact with id '${id}' deleted successfully`,
      });
    }

    // ---------- METHOD NOT ALLOWED ----------
    return sendResponse(405, { message: "Method not allowed" });

  } catch (error) {
    console.error("Error:", error);
    return sendResponse(500, {
      message: "Internal server error",
      error: error.message,
    });
  }
};

// ---------- Helper for consistent API responses ----------
const sendResponse = (statusCode, body) => ({
  statusCode,
  headers: {
    "Access-Control-Allow-Origin": "*",
    "Access-Control-Allow-Methods": "GET,POST,DELETE,OPTIONS",
    "Access-Control-Allow-Headers": "Content-Type",
  },
  body: JSON.stringify(body),
});
