import {
  DynamoDBClient
} from "@aws-sdk/client-dynamodb";
import {
  DynamoDBDocumentClient,
  PutCommand,
  ScanCommand,
  UpdateCommand,
  DeleteCommand,
} from "@aws-sdk/lib-dynamodb";

const client = new DynamoDBClient({ region: "ap-south-1" });
const docClient = DynamoDBDocumentClient.from(client);

export const handler = async (event) => {
  console.log("Event:", event);

  const tableName = "RideExpenses";

  try {
    const method = event.httpMethod || event.requestContext?.http?.method;

    // ---------- CREATE ----------
    if (method === "POST") {
      const body = JSON.parse(event.body);

      const expense = {
        id: body.id,
        type: body.type,
        amount: parseFloat(body.amount),
        description: body.description,
        date: body.date,
        userId: body.userId,
      };

      await docClient.send(
        new PutCommand({
          TableName: tableName,
          Item: expense,
        })
      );

      return sendResponse(200, { message: "Expense saved successfully", expense });
    }

    // ---------- READ ----------
    if (method === "GET") {
      const data = await docClient.send(new ScanCommand({ TableName: tableName }));

      return sendResponse(200, data.Items || []);
    }

    // ---------- UPDATE ----------
    if (method === "PUT") {
      const body = JSON.parse(event.body);

      if (!body.id) return sendResponse(400, { message: "Missing expense id" });

      await docClient.send(
        new UpdateCommand({
          TableName: tableName,
          Key: { id: body.id },
          UpdateExpression:
            "set #t = :type, #a = :amount, #d = :desc, #dt = :date",
          ExpressionAttributeNames: {
            "#t": "type",
            "#a": "amount",
            "#d": "description",
            "#dt": "date",
          },
          ExpressionAttributeValues: {
            ":type": body.type,
            ":amount": parseFloat(body.amount),
            ":desc": body.description,
            ":date": body.date,
          },
          ReturnValues: "UPDATED_NEW",
        })
      );

      return sendResponse(200, { message: "Expense updated successfully" });
    }

    // ---------- DELETE ----------
    if (method === "DELETE") {
      const body = JSON.parse(event.body);

      if (!body.id) return sendResponse(400, { message: "Missing expense id" });

      await docClient.send(
        new DeleteCommand({
          TableName: tableName,
          Key: { id: body.id },
        })
      );

      return sendResponse(200, { message: "Expense deleted successfully" });
    }

    return sendResponse(405, { message: "Method not allowed" });
  } catch (error) {
    console.error("Error:", error);
    return sendResponse(500, { message: "Internal server error", error: error.message });
  }
};

// Helper for consistent response format
const sendResponse = (statusCode, body) => ({
  statusCode,
  headers: {
    "Access-Control-Allow-Origin": "*",
    "Access-Control-Allow-Methods": "GET,POST,PUT,DELETE,OPTIONS",
    "Access-Control-Allow-Headers": "Content-Type",
  },
  body: JSON.stringify(body),
});
