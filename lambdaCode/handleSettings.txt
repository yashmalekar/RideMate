import {
  DynamoDBClient
} from "@aws-sdk/client-dynamodb";
import {
  DynamoDBDocumentClient,
  PutCommand,
  GetCommand,
  UpdateCommand,
  DeleteCommand,
  ScanCommand
} from "@aws-sdk/lib-dynamodb";

const client = new DynamoDBClient({ region: "ap-south-1" });
const docClient = DynamoDBDocumentClient.from(client);

export const handler = async (event) => {
  console.log("Event:", event);

  const tableName = "userSettings";

  try {
    const method = event.httpMethod || event.requestContext?.http?.method;

    // ---------- CREATE / UPDATE ----------
    if (method === "POST") {
      const body = JSON.parse(event.body);

      if (!body.userId)
        return sendResponse(400, { message: "Missing userId" });

      const settings = {
        userId: body.userId,
        accentColor: body.accentColor,
        unit: body.unit,
      };

      await docClient.send(
        new PutCommand({
          TableName: tableName,
          Item: settings,
        })
      );

      return sendResponse(200, {
        message: "User settings saved successfully",
        settings,
      });
    }

    // ---------- READ (GET by userId or all) ----------
    if (method === "GET") {
      const userId = event.queryStringParameters?.userId;

      if (userId) {
        const data = await docClient.send(
          new GetCommand({
            TableName: tableName,
            Key: { userId },
          })
        );

        if (!data.Item)
          return sendResponse(404, { message: "User settings not found" });

        return sendResponse(200, data.Item);
      } else {
        // If no userId, return all (optional)
        const data = await docClient.send(new ScanCommand({ TableName: tableName }));
        return sendResponse(200, data.Items || []);
      }
    }

    return sendResponse(405, { message: "Method not allowed" });
  } catch (error) {
    console.error("Error:", error);
    return sendResponse(500, {
      message: "Internal server error",
      error: error.message,
    });
  }
};

// Helper for consistent response format
const sendResponse = (statusCode, body) => ({
  statusCode,
  headers: {
    "Access-Control-Allow-Origin": "*",
    "Access-Control-Allow-Methods": "GET,POST,PUT,DELETE,OPTIONS",
    "Access-Control-Allow-Headers": "Content-Type",
  },
  body: JSON.stringify(body),
});
